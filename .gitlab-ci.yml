stages:
  - build
  - docker

variables:
  IMAGE_NAME: proxmox-ve-mcp

build:
  stage: build
  image: golang:1.23-alpine
  script:
    - apk add --no-cache make git
    - make build
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes

publish:
  stage: docker
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  dependencies:
    - build
  before_script:
    - mkdir -p ~/.docker
    - |
      echo "{
        \"auths\": {
          \"$HARBOR_REGISTRY\": {
            \"auth\": \"$(printf "%s:%s" "$HARBOR_USERNAME" "$HARBOR_PASSWORD" | base64 | tr -d '\n')\"
          }
        }
      }" > ~/.docker/config.json
    - echo "=== BuildKit Debug: Checking authentication config ==="
    - echo "HOME=$HOME"
    - echo "DOCKER_CONFIG=${DOCKER_CONFIG:-not set (using default ~/.docker)}"
    - test -f ~/.docker/config.json && echo "✓ ~/.docker/config.json exists" || echo "✗ ~/.docker/config.json missing"
    - echo "Config file contents (auth redacted):"
    - cat ~/.docker/config.json | sed 's/"auth": "[^"]*"/"auth": "***REDACTED***"/g' || echo "Failed to read config.json"
    - echo "Registry: $HARBOR_REGISTRY"
    - echo "Username (first 10 chars): ${HARBOR_USERNAME:0:10}..."
    - echo "Password length: ${#HARBOR_PASSWORD} characters"
  script:
    - |
      # Use commit SHA if available, otherwise fall back to pipeline ID
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      echo "=== BuildKit Debug: Starting build ==="
      echo "Image tag: $IMAGE_TAG"
      echo "Registry: $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME"
      
      # Build and push images with BuildKit rootless (multiple outputs for multiple tags)
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$IMAGE_TAG,push=true"
      
      # Add version tag if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG,push=true"
      fi
      
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        $OUTPUT_FLAGS
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes
