stages:
  - build
  - docker

variables:
  HARBOR_REGISTRY: harbor.dataknife.net
  HARBOR_PROJECT: library
  IMAGE_NAME: proxmox-ve-mcp
  DOCKER_TLS_CERTDIR: "/certs"

build:
  stage: build
  image: golang:1.23-alpine
  script:
    - apk add --no-cache make git
    - make build
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - docker

publish:
  stage: docker
  image: docker:24.0.5-cli
  services:
    - docker:24.0.5-dind
  dependencies:
    - build
  before_script:
    - |
      # Wait for Docker daemon to be ready
      until docker info > /dev/null 2>&1; do
        echo "Waiting for Docker daemon..."
        sleep 1
      done
    - docker login -u $HARBOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_REGISTRY
    - docker buildx create --use --driver docker-container --name builder || true
    - docker buildx inspect --bootstrap
  script:
    - |
      # Build and push images with BuildKit
      TAGS="--tag $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest"
      
      # Use commit SHA if available, otherwise fall back to pipeline ID
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      TAGS="$TAGS --tag $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$IMAGE_TAG"
      
      # Add version tag if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAGS="$TAGS --tag $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG"
      fi
      
      docker buildx build --push $TAGS .
  after_script:
    - docker buildx rm builder || true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - docker
