stages:
  - build
  - docker

variables:
  HARBOR_REGISTRY: harbor.dataknife.net
  HARBOR_PROJECT: library
  IMAGE_NAME: proxmox-ve-mcp
  DOCKER_TLS_CERTDIR: "/certs"

build:
  stage: build
  image: golang:1.23-alpine
  script:
    - apk add --no-cache make git
    - make build
  artifacts:
    paths:
      - bin/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - docker

docker-build:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build
  before_script:
    - |
      echo "=== Docker Login Debug ==="
      echo "HARBOR_REGISTRY: $HARBOR_REGISTRY"
      # GitLab expands $$ to $, but shell will expand $library when using double quotes
      # Use single quotes in assignment to prevent shell variable expansion
      HARBOR_USER='robot$library+ci-builder'
      echo "HARBOR_USERNAME (from GitLab var): $HARBOR_USERNAME"
      echo "HARBOR_USER (hardcoded for now): $HARBOR_USER"
      echo "HARBOR_PASSWORD length: ${#HARBOR_PASSWORD}"
      echo "HARBOR_PASSWORD first char: ${HARBOR_PASSWORD:0:1}"
      echo "HARBOR_PASSWORD last char: ${HARBOR_PASSWORD: -1}"
      echo ""
      echo "Attempting docker login..."
      echo "$HARBOR_PASSWORD" | docker login --username "$HARBOR_USER" --password-stdin $HARBOR_REGISTRY || {
        echo "Docker login failed!"
        echo "Exit code: $?"
        exit 1
      }
      echo "Docker login succeeded!"
  script:
    - |
      # Build image once
      docker build -t $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest .
      
      # Tag with commit SHA
      docker tag $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest \
        $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      # Push images
      docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest
      docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      # Tag with version if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest \
          $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG
        docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - docker
